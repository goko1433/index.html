<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ä°ÅŸ Takip UygulamasÄ±</title>
  <style>
    /* Genel Sayfa Stilleri */
    body {
      font-family: 'Roboto', sans-serif;
      background: url('ata.jpg') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 0;
      color: #333;
      transition: background-color 0.5s, color 0.5s;
    }
    /* Gece modu iÃ§in ekstra bir sÄ±nÄ±f */
    .night-mode {
      background: #000 url('ata.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
    }
    /* Gece modunda #app-section'Ä±n arka planÄ±nÄ± siyah (yarÄ± saydam) yapalÄ±m */
    .night-mode #app-section {
      background-color: rgba(0, 0, 0, 0.8);
      color: #fff;
    }

    /* Gece modunda header ve footer da siyah arka plan + beyaz yazÄ± olsun */
    .night-mode header {
      background-color: rgba(0, 0, 0, 0.8);
      color: #fff;
    }
    .night-mode footer {
      background-color: rgba(0, 0, 0, 0.8);
      color: #fff;
    }
    /* Blinking-green de gece modunda okunur olsun */
    .night-mode .blinking-green {
      color: #0f0; /* parlak yeÅŸil */
    }

    header {
      background-color: rgba(30, 42, 58, 0.8);
      color: #fff;
      text-align: center;
      padding: 20px;
      position: relative; /* Gece/GÃ¼ndÃ¼z butonu iÃ§in konumlandÄ±rma */
    }
    #logo {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    #login-buttons {
      margin-top: 10px;
    }
    #login-buttons button {
      padding: 10px 20px;
      margin: 0 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    #login-buttons button:hover {
      opacity: 0.9;
    }
    #google {
      background-color: #4285f4;
      color: #fff;
    }
    #tcmb-login {
      background-color: #34a853;
      color: #fff;
    }
    .blinking-green {
      color: green;
      font-weight: bold;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%   { opacity: 1; }
      50%  { opacity: 0.5; }
      100% { opacity: 1; }
    }
    #app-section {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: 10px;
      transition: background-color 0.5s, color 0.5s;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      background-color: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #0056b3;
    }
    h3 {
      margin-top: 30px;
    }
    #firm-list {
      list-style: none;
      padding: 0;
    }
    #firm-list li {
      background-color: #fff;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      transition: background-color 0.3s;
    }
    #firm-list li:hover {
      background-color: #f9f9f9;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid #ddd;
    }
    th, td {
      padding: 12px;
      text-align: center;
    }
    th {
      background-color: #f1f1f1;
    }
    .edit-btn, .delete-btn {
      padding: 5px 10px;
      margin: 0 5px;
      border-radius: 3px;
      cursor: pointer;
    }
    .edit-btn {
      background-color: #ffc107;
      color: #000;
    }
    .delete-btn {
      background-color: #dc3545;
      color: #fff;
    }
    #clear-btn {
      background-color: #dc3545;
    }
    #clear-btn:hover {
      background-color: #c82333;
    }
    footer {
      background-color: rgba(30, 42, 58, 0.8);
      color: #fff;
      text-align: center;
      padding: 20px;
      margin-top: 40px;
    }
    footer a {
      color: #fff;
      text-decoration: none;
      margin: 0 10px;
    }
    footer a:hover {
      text-decoration: underline;
    }
    /* Toast MesajÄ±: Ortada, yeÅŸil renkli ve animasyonlu */
    .toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #28a745;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 20px 40px;
      border-radius: 8px;
      font-size: 24px;
      font-weight: bold;
      z-index: 10000;
      opacity: 0;
      pointer-events: none;
      animation: fadeInOut 3s ease-in-out forwards;
    }
    @keyframes fadeInOut {
      0%   { opacity: 0; transform: translate(-50%, -60%); }
      20%  { opacity: 1; transform: translate(-50%, -50%); }
      80%  { opacity: 1; transform: translate(-50%, -50%); }
      100% { opacity: 0; transform: translate(-50%, -40%); }
    }
    /* YÃ¼kleme Animasyonu */
    .loader {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      display: none;
      z-index: 1000;
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    /* Modal: Firma DetaylarÄ± */
    #company-details-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 2px solid #007bff;
      border-radius: 8px;
      padding: 20px;
      z-index: 2000;
      display: none;
      max-width: 90%;
      max-height: 90%;
      overflow: auto;
    }
    #company-details-modal h3 {
      margin-top: 0;
    }
    #company-details-modal .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #dc3545;
      color: #fff;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
    }
    /* Gece modunda firma detaylarÄ± modalÄ± da siyah zemin + beyaz yazÄ± olsun */
    .night-mode #company-details-modal {
      background: #333;
      color: #fff;
      border-color: #fff;
    }
    /* Gece modunda tablo baÅŸlÄ±klarÄ± ve hÃ¼creleri de siyah/gri arka plan + beyaz yazÄ± olsun */
    .night-mode #company-details-modal table th {
      background-color: #444;
      color: #fff;
    }
    .night-mode #company-details-modal table td {
      background-color: #333;
      color: #fff;
    }

    /* Firma Son Veri GiriÅŸi BÃ¶lÃ¼mÃ¼ */
    #company-last-entry {
      margin-top: 20px;
    }
    #company-last-entry table {
      width: 100%;
      border-collapse: collapse;
    }
    #company-last-entry th, #company-last-entry td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
    }
    #company-last-entry th {
      background-color: #f1f1f1;
    }
    #company-last-entry a {
      color: #007bff;
      cursor: pointer;
      text-decoration: none;
    }
    #company-last-entry a:hover {
      text-decoration: underline;
    }

    /* Gece modunda #company-last-entry tablolarÄ±nÄ± da okunur hale getirelim */
    .night-mode #company-last-entry th {
      background-color: #444;
      color: #fff;
    }
    .night-mode #company-last-entry td {
      background-color: #333;
      color: #fff;
    }

    /* GÃ¼ndÃ¼z/Gece Modu Butonu: KÃ¼Ã§Ã¼k kutucuk, gÃ¼neÅŸ/ay simgesi */
    #mode-toggle-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      background-color: #ff9800;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      transition: background-color 0.3s;
      outline: none;
    }
    /* VarsayÄ±lan olarak gÃ¼neÅŸ simgesi (â˜€) */
    #mode-toggle-btn::before {
      content: "â˜€";
      display: block;
      font-size: 20px;
      line-height: 38px; /* dikey ortalama */
      text-align: center;
      color: #fff;
    }
    /* Gece modunda buton koyu arka plan + ay simgesi (ðŸŒ™) */
    .night-mode #mode-toggle-btn {
      background-color: #444;
    }
    .night-mode #mode-toggle-btn::before {
      content: "ðŸŒ™";
    }
    /* Hover efektleri */
    #mode-toggle-btn:hover {
      background-color: #e68a00;
    }
    .night-mode #mode-toggle-btn:hover {
      background-color: #555;
    }

    /* Checkbox (Kutucuk) AlanÄ± */
    .checkbox-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    /* Her label iÃ§ine Ã¶zel bir "checkmark" ekliyoruz */
    .checkbox-container label {
      position: relative;
      cursor: pointer;
      user-select: none;
      padding-left: 30px; /* Check kutusu iÃ§in yer aÃ§tÄ±k */
    }
    /* AsÄ±l checkbox gizlenir */
    .checkbox-container input[type="checkbox"] {
      position: absolute;
      opacity: 0;
      cursor: pointer;
      height: 0;
      width: 0;
    }
    /* GÃ¶rsel check kutusu */
    .checkmark {
      position: absolute;
      left: 0;
      top: 3px;
      height: 20px;
      width: 20px;
      background-color: #fff;
      border: 2px solid #ccc;
      border-radius: 4px;
      transition: 0.3s;
    }
    /* Checkbox seÃ§ilince yeÅŸil ve onay tik iÅŸareti */
    .checkbox-container input[type="checkbox"]:checked ~ .checkmark {
      background-color: green;
      border-color: green;
    }
    .checkmark::after {
      content: "";
      position: absolute;
      display: none;
    }
    .checkbox-container input[type="checkbox"]:checked ~ .checkmark:after {
      display: block;
    }
    .checkbox-container .checkmark:after {
      left: 6px;
      top: 2px;
      width: 5px;
      height: 10px;
      border: solid #fff;
      border-width: 0 3px 3px 0;
      transform: rotate(45deg);
    }

    /* YapÄ±lan Ä°ÅŸ Detay KutucuÄŸu (Modal) */
    #job-details-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 2px solid #007bff;
      border-radius: 8px;
      padding: 20px;
      z-index: 3000;
      display: none;
      max-width: 90%;
      max-height: 90%;
      overflow: auto;
    }
    #job-details-modal .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #dc3545;
      color: #fff;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
    }
    .night-mode #job-details-modal {
      background: #333;
      color: #fff;
      border-color: #fff;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <div id="logo">Ä°stanbul Teknik Lazer GÃ¶kberk</div>
    <div id="login-buttons">
      <button id="google" onclick="window.open('https://google.com', '_blank')">Google GiriÅŸ</button>
      <button id="tcmb-login" onclick="window.open('https://www.tcmb.gov.tr', '_blank')">TCMB GiriÅŸ</button>
    </div>
    <div class="blinking-green">Son Veri GiriÅŸi</div>
    <!-- GÃ¼ndÃ¼z/Gece Modu Butonu (kÃ¼Ã§Ã¼k kutu) -->
    <button id="mode-toggle-btn" onclick="toggleMode()"></button>
  </header>

  <div id="app-section">
    <!-- Veri GiriÅŸi Formu -->
    <h3>Veri GiriÅŸi</h3>
    <input type="text" id="firm-name" placeholder="Firma Ä°smi">
    <input type="text" id="work-description" placeholder="YapÄ±lan Ä°ÅŸ AÃ§Ä±klamasÄ±">
    <input type="number" id="amount" placeholder="Fiyat" step="0.01">
    <select id="currency">
      <option value="TL">TL</option>
      <option value="USD">USD</option>
      <option value="EUR">EUR</option>
    </select>
    <input type="text" id="program-name" placeholder="Program Ä°smi">

    <!-- Kutucuklar: lazer kesim, bÃ¼kÃ¼m, kaynak, makas -->
    <div class="checkbox-container">
      <label>
        <input type="checkbox" name="islem" value="lazer">
        <span class="checkmark"></span>
        Lazer Kesim
      </label>
      <label>
        <input type="checkbox" name="islem" value="bukum">
        <span class="checkmark"></span>
        BÃ¼kÃ¼m
      </label>
      <label>
        <input type="checkbox" name="islem" value="kaynak">
        <span class="checkmark"></span>
        Kaynak
      </label>
      <!-- DÃ¶rdÃ¼ncÃ¼ kutucuk (opsiyonel) -->
      <label>
        <input type="checkbox" name="islem" value="makas">
        <span class="checkmark"></span>
        Makas
      </label>
    </div>

    <!-- GÃ¶nderim Butonu: Normalde "Veri GiriÅŸi", dÃ¼zenleme modunda "GÃ¼ncelle" olarak gÃ¶sterilecek -->
    <button id="submit-button" onclick="addData()">Veri GiriÅŸi</button>
    <!-- Verileri Temizle Butonu -->
    <button id="clear-btn" onclick="verifyPIN()">Verileri Temizle</button>
    <!-- Verileri DÄ±ÅŸa Aktar Butonu -->
    <button onclick="exportToCSV()">Verileri CSV Olarak DÄ±ÅŸa Aktar</button>
    <!-- Verileri CSV Olarak YÃ¼kle Butonu -->
    <input type="file" id="csv-file-input" accept=".csv" style="display: none;" onchange="importCSV(event)">
    <button onclick="document.getElementById('csv-file-input').click()">Verileri CSV Olarak YÃ¼kle</button>

    <!-- Firma Listesi -->
    <h3>Firma Listesi</h3>
    <ul id="firm-list"></ul>

    <!-- YapÄ±lan Ä°ÅŸler Tablosu -->
    <h3>YapÄ±lan Ä°ÅŸler</h3>
    <div>
      <label for="filter-firm">Firma Filtrele:</label>
      <input type="text" id="filter-firm" oninput="filterTable()" placeholder="Firma adÄ± girin...">
      <label for="sort-by">SÄ±rala:</label>
      <select id="sort-by" onchange="sortTable()">
        <option value="date">Tarihe GÃ¶re</option>
        <option value="firm">Firmaya GÃ¶re</option>
        <option value="program">Programa GÃ¶re</option>
      </select>
    </div>
    <table>
      <thead>
        <tr>
          <th>Tarih</th>
          <th>YapÄ±lan Ä°ÅŸ</th>
          <th>Firma</th>
          <th>Fiyat</th>
          <th>Firma Toplam</th>
          <th>Program</th>
          <th>Ä°ÅŸlemler</th>
        </tr>
      </thead>
      <tbody id="work-table-body"></tbody>
    </table>
    
    <!-- Yeni Eklenen: FirmalarÄ±n Son Veri GiriÅŸi -->
    <h3>FirmalarÄ±n Son Veri GiriÅŸi</h3>
    <div id="company-last-entry"></div>
  </div>

  <footer>
    <p>Â© 2023 Ä°stanbul Teknik Lazer GÃ¶kberk. TÃ¼m haklarÄ± saklÄ±dÄ±r.</p>
    <p>
      <a href="#">Gizlilik PolitikasÄ±</a> | 
      <a href="#">KullanÄ±m KoÅŸullarÄ±</a> | 
      <a href="#">Ä°letiÅŸim</a>
    </p>
  </footer>

  <!-- Toast MesajÄ± (Geri Bildirim) -->
  <div id="toast" class="toast"></div>

  <!-- YÃ¼kleme Animasyonu -->
  <div id="loader" class="loader"></div>
  
  <!-- Modal: Firma DetaylarÄ± -->
  <div id="company-details-modal">
    <button class="close-btn" onclick="closeCompanyDetails()">X</button>
    <div id="company-details-content"></div>
  </div>

  <!-- Modal: YapÄ±lan Ä°ÅŸ DetaylarÄ± -->
  <div id="job-details-modal">
    <button class="close-btn" onclick="closeJobDetails()">X</button>
    <div id="job-details-content"></div>
  </div>

  <script>
    // Global DeÄŸiÅŸkenler
    let editingIndex = null;
    let entries = JSON.parse(localStorage.getItem('entries')) || [];

    // GÃ¼ndÃ¼z/Gece Modu DeÄŸiÅŸtirme (ArtÄ±k sadece class toggle ile icon deÄŸiÅŸiyor)
    function toggleMode() {
      document.body.classList.toggle('night-mode');
      // Metin deÄŸiÅŸtirmiyoruz; simgeyi CSS ile deÄŸiÅŸtiriyoruz.
    }

    // Tarihi gg.aa.yyyy formatÄ±nda dÃ¶ndÃ¼rÃ¼r.
    function formatDate() {
      const date = new Date();
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}.${month}.${year}`;
    }

    // dd.mm.yyyy formatÄ±ndaki tarih string'ini Date objesine Ã§evirir.
    function parseDate(dateStr) {
      const parts = dateStr.split('.');
      return new Date(parts[2], parts[1] - 1, parts[0]);
    }

    // Toast mesajÄ±nÄ± ortada, yeÅŸil renkli ve animasyonlu gÃ¶sterir.
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.animation = 'none';
      void toast.offsetWidth;
      toast.style.animation = '';
      toast.style.opacity = 1;
      setTimeout(() => {
        toast.style.opacity = 0;
      }, 3000);
    }

    // YÃ¼kleme animasyonunu gÃ¶sterir veya gizler.
    function showLoader(show) {
      const loader = document.getElementById('loader');
      loader.style.display = show ? 'block' : 'none';
    }

    // Firma toplamlarÄ±nÄ± gÃ¼ncelle (localStorage kullanÄ±larak)
    function updateFirmTotals(firmName, amount, currency) {
      let firmTotals = JSON.parse(localStorage.getItem('firmTotals')) || {};
      const key = `${firmName}-${currency}`;
      firmTotals[key] = (firmTotals[key] || 0) + amount;
      localStorage.setItem('firmTotals', JSON.stringify(firmTotals));
    }

    // Belirtilen firmanÄ±n toplamÄ±nÄ± getirir.
    function getFirmTotal(firmName, currency) {
      const firmTotals = JSON.parse(localStorage.getItem('firmTotals')) || {};
      const key = `${firmName}-${currency}`;
      return firmTotals[key] || 0;
    }

    // Veri giriÅŸi (ekleme/dÃ¼zenleme)
    function addData() {
      const firmName = document.getElementById('firm-name').value.trim();
      const description = document.getElementById('work-description').value.trim();
      const amount = parseFloat(document.getElementById('amount').value);
      const currency = document.getElementById('currency').value;
      const programName = document.getElementById('program-name').value.trim();

      // SeÃ§ilen checkbox deÄŸerlerini topla
      const checkboxes = document.querySelectorAll('input[name="islem"]');
      const selectedIslem = [];
      checkboxes.forEach(cb => {
        if (cb.checked) {
          selectedIslem.push(cb.value);
        }
      });

      if (!firmName || !description || isNaN(amount) || amount <= 0 || !programName) {
        alert("LÃ¼tfen tÃ¼m alanlarÄ± geÃ§erli ÅŸekilde doldurun.");
        return;
      }

      showLoader(true);

      setTimeout(() => {
        if (editingIndex !== null) {
          // DÃ¼zenleme modunda: Ã–nce eski kaydÄ±n etkisini Ã§Ä±kar
          const oldEntry = entries[editingIndex];
          updateFirmTotals(oldEntry.firmName, -oldEntry.amount, oldEntry.currency);

          // Yeni veriyi gÃ¼ncelle
          entries[editingIndex] = {
            date: formatDate(),
            firmName,
            description,
            amount,
            currency,
            programName,
            islem: selectedIslem
          };
          updateFirmTotals(firmName, amount, currency);
          showToast("GÃ¼ncellendi!");
          editingIndex = null;

          // DÃ¼zenleme modundan Ã§Ä±kÄ±nca buton metnini eski haline getir
          document.getElementById('submit-button').textContent = "Veri GiriÅŸi";
        } else {
          // Yeni giriÅŸ ekle
          entries.push({
            date: formatDate(),
            firmName,
            description,
            amount,
            currency,
            programName,
            islem: selectedIslem
          });
          updateFirmTotals(firmName, amount, currency);
          showToast("BaÅŸarÄ±yla Kaydedildi!");
        }
        localStorage.setItem('entries', JSON.stringify(entries));
        loadEntries();
        loadFirms();
        loadCompanyLastEntry();
        clearForm();
        showLoader(false);
      }, 1000);
    }

    // GiriÅŸi siler.
    function deleteEntry(index) {
      const entry = entries[index];
      entries.splice(index, 1);
      localStorage.setItem('entries', JSON.stringify(entries));
      updateFirmTotals(entry.firmName, -entry.amount, entry.currency);
      loadEntries();
      loadFirms();
      loadCompanyLastEntry();
      showToast("BaÅŸarÄ±yla Silindi!");
    }

    // GiriÅŸin dÃ¼zenlenmesi: Form alanlarÄ±nÄ± doldurur ve gÃ¶nderim butonunu "GÃ¼ncelle" yapar.
    function editEntry(index) {
      editingIndex = index;
      const entry = entries[index];
      document.getElementById('firm-name').value = entry.firmName;
      document.getElementById('work-description').value = entry.description;
      document.getElementById('amount').value = entry.amount;
      document.getElementById('currency').value = entry.currency;
      document.getElementById('program-name').value = entry.programName;

      // Daha Ã¶nce seÃ§ili olan kutucuklarÄ± iÅŸaretle
      const checkboxes = document.querySelectorAll('input[name="islem"]');
      checkboxes.forEach(cb => {
        cb.checked = entry.islem && entry.islem.includes(cb.value);
      });

      // Buton metnini gÃ¼ncelleme moduna geÃ§ir
      document.getElementById('submit-button').textContent = "GÃ¼ncelle";
    }

    // Formu temizler ve gÃ¶nderim butonunu varsayÄ±lan hale getirir.
    function clearForm() {
      document.getElementById('firm-name').value = '';
      document.getElementById('work-description').value = '';
      document.getElementById('amount').value = '';
      document.getElementById('program-name').value = '';

      // Check kutucuklarÄ±nÄ± sÄ±fÄ±rla
      const checkboxes = document.querySelectorAll('input[name="islem"]');
      checkboxes.forEach(cb => cb.checked = false);

      // VarsayÄ±lan buton metni
      document.getElementById('submit-button').textContent = "Veri GiriÅŸi";
    }

    // Tabloya kayÄ±tlarÄ± yÃ¼kler.
    function loadEntries() {
      const tableBody = document.getElementById('work-table-body');
      tableBody.innerHTML = "";
      entries.forEach((entry, index) => {
        const row = tableBody.insertRow();
        const dateCell = row.insertCell();
        const descCell = row.insertCell();
        const firmCell = row.insertCell();
        const amountCell = row.insertCell();
        const firmTotalCell = row.insertCell();
        const programCell = row.insertCell();
        const actionsCell = row.insertCell();

        dateCell.textContent = entry.date;

        // Ä°ÅŸ aÃ§Ä±klamasÄ±na, seÃ§ilen kutucuklarÄ± ekle
        let islemText = "";
        if (entry.islem && entry.islem.length > 0) {
          islemText = ` (SeÃ§ilen: ${entry.islem.join(', ')})`;
        }
        descCell.textContent = entry.description + islemText;

        // Yeni eklenen: descCell'e tÄ±klayÄ±nca detay kutucuÄŸu aÃ§Ä±lsÄ±n
        descCell.style.cursor = "pointer";
        descCell.onclick = () => showJobDetails(entry);

        firmCell.textContent = entry.firmName;
        amountCell.textContent = `${entry.amount} ${entry.currency}`;
        firmTotalCell.textContent = `${getFirmTotal(entry.firmName, entry.currency)} ${entry.currency}`;
        programCell.textContent = entry.programName;

        // Ä°ÅŸlemler: DÃ¼zenle ve Sil butonlarÄ±
        const editBtn = document.createElement('button');
        editBtn.textContent = "DÃ¼zenle";
        editBtn.className = "edit-btn";
        editBtn.onclick = () => editEntry(index);

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = "Sil";
        deleteBtn.className = "delete-btn";
        deleteBtn.onclick = () => deleteEntry(index);

        actionsCell.appendChild(editBtn);
        actionsCell.appendChild(deleteBtn);
      });
    }

    // Firma listesini gÃ¼nceller.
    function loadFirms() {
      const firmListEl = document.getElementById('firm-list');
      firmListEl.innerHTML = "";
      const firms = getUniqueFirms();
      firms.forEach(firm => {
        const li = document.createElement('li');
        li.textContent = firm;
        firmListEl.appendChild(li);
      });
    }

    // Benzersiz firma isimlerini dÃ¶ndÃ¼rÃ¼r.
    function getUniqueFirms() {
      const firms = new Set();
      entries.forEach(entry => firms.add(entry.firmName));
      return Array.from(firms);
    }

    // Tabloyu, girilen firma adÄ±na gÃ¶re filtreler.
    function filterTable() {
      const filterText = document.getElementById('filter-firm').value.toLowerCase();
      const tableRows = document.getElementById('work-table-body').rows;
      for (let row of tableRows) {
        const firmName = row.cells[2].textContent.toLowerCase();
        row.style.display = firmName.includes(filterText) ? "" : "none";
      }
    }

    // SeÃ§ilen kritere gÃ¶re kayÄ±tlarÄ± sÄ±ralar.
    function sortTable() {
      const sortBy = document.getElementById('sort-by').value;
      entries.sort((a, b) => {
        if (sortBy === "date") {
          const dateA = new Date(a.date.split('.').reverse().join('-'));
          const dateB = new Date(b.date.split('.').reverse().join('-'));
          return dateA - dateB;
        } else if (sortBy === "firm") {
          return a.firmName.localeCompare(b.firmName);
        } else if (sortBy === "program") {
          return a.programName.localeCompare(b.programName);
        }
      });
      localStorage.setItem('entries', JSON.stringify(entries));
      loadEntries();
    }

    // CSV Olarak dÄ±ÅŸa aktarÄ±r.
    function exportToCSV() {
      if (entries.length === 0) {
        alert("DÄ±ÅŸa aktarÄ±lacak veri yok.");
        return;
      }
      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "Tarih,YapÄ±lan Ä°ÅŸ,Firma,Fiyat,Para Birimi,Program,SeÃ§ilen Ä°ÅŸlemler\n";
      entries.forEach(entry => {
        const islemList = entry.islem ? entry.islem.join('|') : ""; 
        csvContent += `${entry.date},${entry.description},${entry.firmName},${entry.amount},${entry.currency},${entry.programName},${islemList}\n`;
      });
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "veriler.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // CSV dosyasÄ±nÄ± iÃ§e aktarÄ±r.
    function importCSV(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.trim().split("\n");
        const newEntries = [];
        for (let i = 1; i < lines.length; i++) {
          const cols = lines[i].split(",");
          if (cols.length < 7) continue; 
          const [date, description, firmName, amount, currency, programName, islemList] = cols;
          const parsedIslem = islemList ? islemList.split('|') : [];
          newEntries.push({
            date: date.trim(),
            description: description.trim(),
            firmName: firmName.trim(),
            amount: parseFloat(amount),
            currency: currency.trim(),
            programName: programName.trim(),
            islem: parsedIslem
          });
        }
        entries = newEntries;
        localStorage.setItem('entries', JSON.stringify(entries));
        loadEntries();
        loadFirms();
        loadCompanyLastEntry();
        showToast("CSV baÅŸarÄ±yla yÃ¼klendi!");
      }
      reader.readAsText(file);
    }

    // Verileri temizlemek iÃ§in PIN doÄŸrulamasÄ± yapar.
    function verifyPIN() {
      const pin = prompt("Verileri temizlemek iÃ§in PIN giriniz:");
      if (pin === "1234") {
        entries = [];
        localStorage.removeItem('entries');
        localStorage.removeItem('firmTotals');
        loadEntries();
        loadFirms();
        loadCompanyLastEntry();
        showToast("Veriler temizlendi!");
      } else {
        alert("YanlÄ±ÅŸ PIN!");
      }
    }

    // Firma iÃ§in son veri giriÅŸ tarihini dÃ¶ndÃ¼rÃ¼r.
    function getLatestEntryDate(firmName) {
      let latest = null;
      entries.forEach(entry => {
        if (entry.firmName === firmName) {
          const entryDate = parseDate(entry.date);
          if (!latest || entryDate > latest) {
            latest = entryDate;
          }
        }
      });
      return latest;
    }

    // Firma son veri giriÅŸlerini listeleyen bÃ¶lÃ¼mÃ¼ yÃ¼kler.
    function loadCompanyLastEntry() {
      const container = document.getElementById('company-last-entry');
      container.innerHTML = "";
      const firms = getUniqueFirms();
      if (firms.length === 0) {
        container.innerHTML = "<p>HenÃ¼z firma verisi yok.</p>";
        return;
      }
      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      const thFirm = document.createElement("th");
      thFirm.textContent = "Firma";
      const thLastEntry = document.createElement("th");
      thLastEntry.textContent = "Son Veri GiriÅŸi";
      headerRow.appendChild(thFirm);
      headerRow.appendChild(thLastEntry);
      thead.appendChild(headerRow);
      table.appendChild(thead);
      const tbody = document.createElement("tbody");
      firms.forEach(firm => {
        const tr = document.createElement("tr");
        const tdFirm = document.createElement("td");
        const firmLink = document.createElement("a");
        firmLink.textContent = firm;
        firmLink.onclick = () => showCompanyDetails(firm);
        tdFirm.appendChild(firmLink);
        const tdLastEntry = document.createElement("td");
        const latestDate = getLatestEntryDate(firm);
        tdLastEntry.textContent = latestDate ? latestDate.toLocaleDateString("tr-TR") : "Yok";
        tr.appendChild(tdFirm);
        tr.appendChild(tdLastEntry);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);
    }

    // Firma detaylarÄ±nÄ± gÃ¶sterir (modal aÃ§ar).
    function showCompanyDetails(firmName) {
      // SeÃ§ilen firmanÄ±n tÃ¼m verilerini filtrele
      const firmEntries = entries.filter(entry => entry.firmName === firmName);
      if (firmEntries.length === 0) return;

      // Her para birimi iÃ§in toplam hesapla
      let totalTL = 0, totalUSD = 0, totalEUR = 0;
      firmEntries.forEach(entry => {
        if (entry.currency === "TL") totalTL += entry.amount;
        else if (entry.currency === "USD") totalUSD += entry.amount;
        else if (entry.currency === "EUR") totalEUR += entry.amount;
      });

      // Son veri giriÅŸi tarihi
      const latestDate = getLatestEntryDate(firmName);
      const latestDateStr = latestDate ? latestDate.toLocaleDateString("tr-TR") : "Yok";

      // Veri giriÅŸlerinin aylara gÃ¶re daÄŸÄ±lÄ±mÄ± (her ay kaÃ§ giriÅŸ yapÄ±lmÄ±ÅŸ)
      const monthlyData = {};
      firmEntries.forEach(entry => {
        const date = parseDate(entry.date);
        const monthYear = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}`;
        if (!monthlyData[monthYear]) {
          monthlyData[monthYear] = 0;
        }
        monthlyData[monthYear]++;
      });

      // Modal iÃ§eriÄŸini oluÅŸtur
      const modalContent = document.getElementById('company-details-content');
      modalContent.innerHTML = `<h3>${firmName} DetaylarÄ±</h3>
        <p><strong>Toplam Ä°ÅŸ TutarÄ±:</strong> TL: ${totalTL.toFixed(2)}, USD: ${totalUSD.toFixed(2)}, EUR: ${totalEUR.toFixed(2)}</p>
        <p><strong>Son Veri GiriÅŸi:</strong> ${latestDateStr}</p>
        <p><strong>Veri GiriÅŸi YapÄ±lmadÄ±ÄŸÄ± SÃ¼re:</strong> ${latestDate ? Math.floor((new Date() - latestDate) / (1000 * 60 * 60 * 24)) : "0"} gÃ¼n</p>
        <h4>Aylara GÃ¶re Veri GiriÅŸi</h4>
        <table>
          <thead>
            <tr>
              <th>Ay</th>
              <th>GiriÅŸ SayÄ±sÄ±</th>
            </tr>
          </thead>
          <tbody>
            ${
              Object.entries(monthlyData)
                .map(([month, count]) => `<tr><td>${month}</td><td>${count}</td></tr>`)
                .join('')
            }
          </tbody>
        </table>
      `;
      // ModalÄ± gÃ¶ster
      document.getElementById('company-details-modal').style.display = 'block';
    }

    // ModalÄ± kapatÄ±r.
    function closeCompanyDetails() {
      document.getElementById('company-details-modal').style.display = 'none';
    }

    // YapÄ±lan Ä°ÅŸ Detay KutucuÄŸu (modal) gÃ¶ster
    function showJobDetails(entry) {
      const modal = document.getElementById('job-details-modal');
      const content = document.getElementById('job-details-content');

      // SeÃ§ili iÅŸlemler metni
      let islemText = "SeÃ§ilen iÅŸlem yok";
      if (entry.islem && entry.islem.length > 0) {
        islemText = entry.islem.join(', ');
      }

      content.innerHTML = `
        <h3>Ä°ÅŸ DetayÄ±</h3>
        <p><strong>Tarih:</strong> ${entry.date}</p>
        <p><strong>AÃ§Ä±klama:</strong> ${entry.description}</p>
        <p><strong>SeÃ§ili Kutucuklar:</strong> ${islemText}</p>
      `;

      modal.style.display = 'block';
    }

    // YapÄ±lan Ä°ÅŸ Detay KutucuÄŸu (modal) kapat
    function closeJobDetails() {
      document.getElementById('job-details-modal').style.display = 'none';
    }

    // Sayfa yÃ¼klendiÄŸinde kayÄ±tlarÄ± yÃ¼kler.
    window.onload = function() {
      loadEntries();
      loadFirms();
      loadCompanyLastEntry();
    };
  </script>
</body>
</html>
